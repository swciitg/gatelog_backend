<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>All Khokha Entries</title>

  <!-- jQuery & DataTables -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
  <script src="https://cdn.datatables.net/responsive/2.4.1/js/dataTables.responsive.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.4.1/css/responsive.dataTables.min.css">

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #ececec; color: #090909; margin: 0; padding: 20px; box-shadow: inset 0 0 50px #787676; }
    .logout-link { position: absolute; top: 30px; right: 80px; color: #20363d; text-decoration: none; font-weight: bold; transition: color 0.3s ease; }
    .logout-link:hover { color: #78878d; }
    .container { background-color:#ececec; padding: 40px; border-radius: 12px; box-shadow: 0 8px 16px rgba(0,0,0,0.5); max-width: 95%; margin: auto; font-size: 1.1rem; }
    h1 { color: #121213; text-align: center; margin-bottom: 30px; font-weight: 500; font-size: 3rem; }
    .dataTables_length{ padding-bottom: 20px; }
    .dataTables_length select { background-color: #1b1b1b; color: #090909; padding: 4px 8px; }
    .dataTables_length select option { background-color: #ececec; color: #090909; }
    .dataTables_paginate .paginate_button { color: #090909 !important; border: 1px solid #333 !important; border-radius: 5px; margin: 2px; }
    ::-webkit-scrollbar { height: 10px; }
    ::-webkit-scrollbar-track { background: #d6d0d0; }
    ::-webkit-scrollbar-thumb { background: #5c6976; border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: #888; }
    div.dataTables_scroll { border-radius: 6px; overflow-x: auto; border: 1px solid #444 !important; }
    table.dataTable thead { background-color: #334a61; color: #f4f7f9d7; border-radius: 15px 15px 0 0; }
    table.dataTable thead th, table.dataTable tbody td { text-align: center; vertical-align: middle; padding: 12px 25px; }
    #entriesTable tbody tr:hover { background-color: rgba(128,206,241,0.1) !important; cursor: pointer; }
    .badge-open { background:#fff3cd; color:#664d03; }
    .badge-closed { background:#d1e7dd; color:#0f5132; }
    .btn-compact { padding: .2rem .5rem; font-size: .8rem; }
    @media (max-width: 600px) { .container { padding: 15px; } h1{ font-size: 2rem; font-weight: 300; } }
  </style>
</head>

<body>
  <div class="container">
    <h1 id="welcomemsg"></h1>
    <a href="<%= process.env.BASE_URL %>/v1/admin/logout" class="logout-link">Logout</a>

    <h1>All Khokha Entries</h1>

    <div class="d-flex flex-wrap justify-content-end mb-3 gap-2">
      <a class="btn btn-primary" href="<%= BASE_URL %>/entries/new">+ Add New Entry</a>

      <!-- Close by roll -->
      <div class="input-group" style="max-width: 360px;">
        <input id="close-roll-input" class="form-control" placeholder="Close by Roll No">
        <button id="btn-close-by-roll" class="btn btn-danger">Close</button>
      </div>

      <!-- Export -->
      <button id="btn-export-xlsx" class="btn btn-success">⬇ Export Excel</button>
      <button id="btn-export-csv" class="btn btn-outline-secondary">⬇ Export CSV</button>
    </div>

    <!-- FILTER TOOLBAR -->
    <div class="card p-3 mb-3">
      <div class="row g-2 align-items-end">
        <div class="col-md-2"><label class="form-label">Name</label><input id="f-name" class="form-control" /></div>
        <div class="col-md-2"><label class="form-label">Roll No</label><input id="f-roll" class="form-control" /></div>
        <div class="col-md-2"><label class="form-label">Outlook</label><input id="f-outlook" class="form-control" /></div>
        <div class="col-md-2"><label class="form-label">Phone</label><input id="f-phone" class="form-control" /></div>
        <div class="col-md-2"><label class="form-label">Room</label><input id="f-room" class="form-control" /></div>
        <div class="col-md-2"><label class="form-label">Destination</label>
          <select id="f-dest" class="form-select">
            <option value="">All</option>
            <option value="City">City</option>
            <option value="Khoka">Khoka</option>
            <option value="Other">Other</option>
          </select>
        </div>

        <div class="col-md-2">
          <label class="form-label">Hostel</label>
          <select id="f-hostel" class="form-select">
            <option value="">All</option>
            <option>LOHIT</option><option>BRAHMAPUTRA</option><option>DISANG</option>
            <option>KAMENG</option><option>BARAK</option><option>MANAS</option>
            <option>DIHING</option><option>UMIAM</option><option>SIANG</option>
            <option>KAPILI</option><option>DHANSIRI</option><option>SUBANSIRI</option>
            <option>MSH</option><option>GAURANG</option><option>DIBANG</option>
            <option>NON-HOSTELLER</option>
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">Status</label>
          <select id="f-status" class="form-select">
            <option value="">All</option>
            <option>Open</option>
            <option>Closed</option>
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">Out Gate</label>
          <select id="f-outgate" class="form-select">
            <option value="">All</option>
            <option>Main_Gate</option>
            <option>KV_Gate</option>
            <option>Khoka_Gate</option>
            <option>AUTO_CLOSED</option>
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">In Gate</label>
          <select id="f-ingate" class="form-select">
            <option value="">All</option>
            <option>Main_Gate</option>
            <option>KV_Gate</option>
            <option>Khoka_Gate</option>
            <option>AUTO_CLOSED</option>
            <option>—</option>
          </select>
        </div>

        <div class="col-md-2"><label class="form-label">Check-Out from</label><input id="f-co-from" type="datetime-local" class="form-control" /></div>
        <div class="col-md-2"><label class="form-label">Check-Out to</label><input id="f-co-to" type="datetime-local" class="form-control" /></div>
        <div class="col-md-2"><label class="form-label">Check-In from</label><input id="f-ci-from" type="datetime-local" class="form-control" /></div>
        <div class="col-md-2"><label class="form-label">Check-In to</label><input id="f-ci-to" type="datetime-local" class="form-control" /></div>

        <div class="col-md-2"><button id="f-reset" class="btn btn-outline-secondary w-100">Reset Filters</button></div>
      </div>
    </div>

    <!-- TABLE (empty body; rows are fetched page-wise) -->
    <table id="entriesTable" class="display nowrap" style="width:100%">
      <thead>
        <tr>
          <th>Name</th>
          <th>Roll No</th>
          <th>Outlook</th>
          <th>Phone</th>
          <th>Hostel</th>
          <th>Room</th>
          <th>Destination</th>
          <th>Status</th>
          <th>Gate</th>
          <th>Check-Out</th>
          <th>Check-In</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- DETAILS MODAL -->
  <div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
    <div class="modal-dialog"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="detailsModalLabel">Entry Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="modalContent"></div>
    </div></div>
  </div>

  <!-- Welcome typer -->
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const userEmail = "<%= user %>";
      const text = `Welcome, ${userEmail}!`;
      const element = document.getElementById("welcomemsg");
      let index = 0;
      (function typeNextChar() {
        if (index < text.length) { element.textContent += text.charAt(index++); setTimeout(typeNextChar, 80); }
      })();
    });
  </script>

  <!-- DataTables server-side + filters + export + close-by-roll -->
  <script>
    const BASE_URL = '<%= BASE_URL %>';
    let table;

    const collectFilters = () => ({
      name:   document.getElementById('f-name').value.trim(),
      rollNumber: document.getElementById('f-roll').value.trim(),
      outlook: document.getElementById('f-outlook').value.trim(),
      phone:  document.getElementById('f-phone').value.trim(),
      room:   document.getElementById('f-room').value.trim(),
      destination: document.getElementById('f-dest').value,
      hostel: document.getElementById('f-hostel').value,
      status: document.getElementById('f-status').value,
      outGate:document.getElementById('f-outgate').value,
      inGate: document.getElementById('f-ingate').value,
      coFrom: document.getElementById('f-co-from').value,
      coTo:   document.getElementById('f-co-to').value,
      ciFrom: document.getElementById('f-ci-from').value,
      ciTo:   document.getElementById('f-ci-to').value
    });

    $(document).ready(function () {
      table = $('#entriesTable').DataTable({
        serverSide: true,
        processing: true,
        responsive: true,
        deferRender: true,
        pageLength: 25,
        lengthMenu: [10, 25, 50, 100, 200],
        // We rely on backend to always return latest-first by updatedAt
        order: [], // no client ordering
        ajax: {
          url: `${BASE_URL}/entries/table`,
          type: 'POST',
          contentType: 'application/json',
          data: function (d) {
            // Attach our filters; keep DataTables draw/start/length for server
            return JSON.stringify({
              draw: d.draw, start: d.start, length: d.length,
              filters: collectFilters()
            });
          },
          dataSrc: 'data'
        },
        columns: [
          { data: 'name' },
          { data: 'rollNumber' },
          { data: 'outlookEmail' },
          { data: 'phoneNumber' },
          { data: 'hostel' },
          { data: 'roomNumber' },
          { data: 'destination' },
          { data: 'isClosed', render: (v) => v
              ? '<span class="badge badge-closed">Closed</span>'
              : '<span class="badge badge-open">Open</span>' },
          { data: null, orderable: false, searchable: false, render: (row) =>
              `<div><strong>Out:</strong> ${row.checkOutGate || ''}</div>
               <div><strong>In:</strong> ${row.checkInGate || '—'}</div>` },
          { data: 'checkOutTime', render: (iso) => iso ? new Date(iso).toLocaleString() : '—' },
          { data: 'checkInTime',  render: (iso) => iso ? new Date(iso).toLocaleString()  : '—' },
          { data: null, orderable: false, searchable: false, render: (row) => row.isClosed
              ? '<span class="text-muted">—</span>'
              : `<button class="btn btn-sm btn-danger btn-compact btn-close-roll" data-roll="${row.rollNumber}">Close</button>` }
        ]
      });

      // Any filter change → reload current page (keeps pagination after change)
      $('#f-name,#f-roll,#f-outlook,#f-phone,#f-room').on('input',  () => table.ajax.reload(null, true));
      $('#f-dest,#f-hostel,#f-status,#f-outgate,#f-ingate,#f-co-from,#f-co-to,#f-ci-from,#f-ci-to')
        .on('change', () => table.ajax.reload(null, true));

      $('#f-reset').on('click', function(){
        $('#f-name,#f-roll,#f-outlook,#f-phone,#f-room').val('');
        $('#f-dest,#f-hostel,#f-status,#f-outgate,#f-ingate').val('');
        $('#f-co-from,#f-co-to,#f-ci-from,#f-ci-to').val('');
        table.ajax.reload(null, true);
      });

      // Periodic refresh (stays on same page)
      setInterval(() => table.ajax.reload(null, false), 30000);

      // Details modal
      $('#entriesTable tbody').on('click', 'tr', function (e) {
        if (e.target && (e.target.classList.contains('btn-close-roll') || e.target.closest('.btn-close-roll'))) return;
        const row = table.row(this).data();
        if (!row) return;
        const details = `
          <p><strong>Name:</strong> ${row.name}</p>
          <p><strong>Roll No:</strong> ${row.rollNumber}</p>
          <p><strong>Outlook:</strong> ${row.outlookEmail}</p>
          <p><strong>Phone:</strong> ${row.phoneNumber}</p>
          <p><strong>Hostel:</strong> ${row.hostel}</p>
          <p><strong>Room:</strong> ${row.roomNumber}</p>
          <p><strong>Destination:</strong> ${row.destination}</p>
          <p><strong>Status:</strong> ${row.isClosed ? 'Closed' : 'Open'}</p>
          <p><strong>Gate:</strong> Out: ${row.checkOutGate || ''} • In: ${row.checkInGate || '—'}</p>
          <p><strong>Check-Out:</strong> ${row.checkOutTime ? new Date(row.checkOutTime).toLocaleString() : '—'}</p>
          <p><strong>Check-In:</strong> ${row.checkInTime ? new Date(row.checkInTime).toLocaleString() : '—'}</p>
        `;
        $('#modalContent').html(details);
        $('#detailsModal').modal('show');
      });

      // Row-level Close button
      $('#entriesTable tbody').on('click', '.btn-close-roll', async function () {
        const roll = this.getAttribute('data-roll');
        if (!roll) return;
        if (!confirm(`Close open entry for roll ${roll}?`)) return;
        await closeByRoll(roll);
      });

      // Topbar close
      document.getElementById('btn-close-by-roll').addEventListener('click', async () => {
        const roll = document.getElementById('close-roll-input').value.trim();
        if (!roll) return alert('Enter a roll number.');
        if (!confirm(`Close open entry for roll ${roll}?`)) return;
        await closeByRoll(roll);
      });

      // Export current FILTERED set (full set, not just current page)
      const postExport = (format) => {
        const f = collectFilters();
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `${BASE_URL}/entries/export`;
        // map filters to existing export API body
        const add = (k,v) => { const i=document.createElement('input'); i.type='hidden'; i.name=k; i.value=v; form.appendChild(i); };
        add('dateField','updatedAt'); // export sorted by latest
        add('from', f.coFrom || '1970-01-01T00:00');
        add('to',   f.coTo   || new Date().toISOString().slice(0,16));
        if (f.name)        add('name', f.name);
        if (f.rollNumber)  add('rollNumber', f.rollNumber);
        if (f.hostel)      add('hostel', f.hostel);
        if (f.room)        add('roomNumber', f.room);
        if (f.destination) add('destination', f.destination);
        if (f.outGate)     add('checkOutGate', f.outGate);
        if (f.inGate)      add('checkInGate', f.inGate === '—' ? '' : f.inGate);
        if (f.status === 'Open')   add('isClosed', 'false');
        if (f.status === 'Closed') add('isClosed', 'true');
        add('format', format);
        document.body.appendChild(form);
        form.submit();
        form.remove();
      };
      $('#btn-export-xlsx').on('click', () => postExport('xlsx'));
      $('#btn-export-csv').on('click',  () => postExport('csv'));
    });

    async function closeByRoll(roll) {
      try {
        const resp = await fetch(`${BASE_URL}/entries/close-by-roll`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ rollNumber: roll, checkInGate: 'AUTO_CLOSED' })
        });
        if (!resp.ok) {
          const t = await resp.text();
          alert(t || 'Close failed.');
          return;
        }
        // reload current page without resetting pagination
        $('#entriesTable').DataTable().ajax.reload(null, false);
        alert(`Entry for roll ${roll} closed.`);
      } catch (err) {
        console.error(err);
        alert('Close failed.');
      }
    }
  </script>
</body>
</html>
