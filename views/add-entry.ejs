<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Add Khokha Entry</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"/>
  <style>
    body { background:#ececec; }
    .container { max-width: 900px; background:#fff; margin-top: 30px; padding: 24px; border-radius: 12px; box-shadow: 0 8px 16px rgba(0,0,0,.1); }
    .form-section { padding:16px; border:1px solid #e5e7eb; border-radius:10px; background:#fafafa; }
    .readonly { background:#f3f4f6; }
  </style>
</head>
<body>
<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="m-0">Add Khokha Entry</h2>
    <a class="btn btn-outline-secondary" href="<%= BASE_URL %>">‚Üê Back</a>
  </div>

  <div id="alertBox" class="alert d-none" role="alert"></div>

  <!-- Lookup section -->
  <div class="form-section mb-3">
    <div class="row g-3 align-items-end">
      <div class="col-md-6">
        <label class="form-label">Name</label>
        <input id="name" type="text" class="form-control" placeholder="Full name" required>
      </div>
      <div class="col-md-6">
        <label class="form-label">Roll Number</label>
        <input id="rollNumber" type="text" class="form-control" placeholder="123456" required>
      </div>
      <div class="col-12">
        <button id="fetchBtn" class="btn btn-primary">Fetch Details</button>
      </div>
    </div>
  </div>

  <!-- Form -->
  <form id="entryForm" method="POST" action="<%= BASE_URL %>/entries">
    <input type="hidden" name="name" id="f_name">
    <input type="hidden" name="rollNumber" id="f_rollNumber">

    <div class="row g-3">
      <div class="col-md-6">
        <label class="form-label">Outlook Email</label>
        <input name="outlookEmail" id="outlookEmail" type="email" class="form-control readonly" readonly required>
      </div>
      <div class="col-md-6">
        <label class="form-label">Phone Number</label>
        <input name="phoneNumber" id="phoneNumber" type="tel" class="form-control readonly" readonly required>
      </div>

      <div class="col-md-6">
        <label class="form-label">Hostel</label>
        <input name="hostel" id="hostel" type="text" class="form-control readonly" readonly required>
      </div>
      <div class="col-md-6">
        <label class="form-label">Room Number</label>
        <input name="roomNumber" id="roomNumber" type="text" class="form-control readonly" readonly required>
      </div>

      <div class="col-12">
        <label class="form-label">Destination</label>
        <input name="destination" id="destination" type="text" class="form-control" placeholder="City/Location" required>
      </div>

      <div class="col-md-6">
        <label class="form-label">Check-Out Time</label>
        <input name="checkOutTime" id="checkOutTime" type="datetime-local" class="form-control" required>
      </div>
      <div class="col-md-6">
        <label class="form-label">Exit Gate</label>
        <select name="checkOutGate" id="checkOutGate" class="form-select" required>
          <option value="">Select...</option>
          <option value="Main_Gate">Main_Gate</option>
          <option value="KV_Gate">KV_Gate</option>
          <option value="Khoka_Gate">Khoka_Gate</option>
        </select>
      </div>

      <div class="col-md-6">
        <label class="form-label">Check-In Time (optional)</label>
        <input name="checkInTime" id="checkInTime" type="datetime-local" class="form-control">
      </div>
      <div class="col-md-6">
        <label class="form-label">Check-In Gate (optional)</label>
        <select name="checkInGate" id="checkInGate" class="form-select">
          <option value="">Select...</option>
          <option value="Main_Gate">Main_Gate</option>
          <option value="KV_Gate">KV_Gate</option>
          <option value="Khoka_Gate">Khoka_Gate</option>
          <option value="AUTO_CLOSED">AUTO_CLOSED</option>
        </select>
      </div>

      <div class="col-12">
        <div class="form-check">
          <input name="isClosed" id="isClosed" class="form-check-input" type="checkbox" value="true">
          <label class="form-check-label" for="isClosed">Mark as Closed</label>
        </div>
      </div>
    </div>

    <div class="mt-4 d-flex gap-2">
      <button type="submit" class="btn btn-success">Save Entry</button>
      <button type="reset" class="btn btn-outline-secondary">Reset</button>
    </div>
  </form>
</div>

<script>
  const BASE_URL = '<%= BASE_URL %>';

  const alertBox = document.getElementById('alertBox');
  function showAlert(type, msg) {
    alertBox.className = 'alert alert-' + type;
    alertBox.textContent = msg;
    alertBox.classList.remove('d-none');
  }

  document.getElementById('fetchBtn').addEventListener('click', async (e) => {
    e.preventDefault();
    alertBox.classList.add('d-none');

    const name = document.getElementById('name').value.trim();
    const roll = document.getElementById('rollNumber').value.trim();

    if (!name || !roll) {
      showAlert('warning', 'Please enter Name and Roll Number first.');
      return;
    }

    document.getElementById('f_name').value = name;
    document.getElementById('f_rollNumber').value = roll;

    try {
      const res = await fetch(`${BASE_URL}/entries/lookup`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, rollNumber: roll })
      });

      if (!res.ok) {
        const t = await res.text();
        throw new Error(t || 'Lookup failed');
      }

      const data = await res.json();
      document.getElementById('outlookEmail').value = data.outlookEmail || '';
      document.getElementById('phoneNumber').value = data.phoneNumber || '';
      document.getElementById('hostel').value = data.hostel || '';
      document.getElementById('roomNumber').value = data.roomNumber || '';

      showAlert('success', 'Details fetched successfully.');
    } catch (err) {
      showAlert('danger', `Failed to fetch details: ${err.message}`);
    }
  });

  const now = new Date();
  now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
  document.getElementById('checkOutTime').value = now.toISOString().slice(0,16);
</script>
</body>
</html>
