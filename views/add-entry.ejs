<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Add Khokha Entry</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"/>
  <style>
    body { background:#f4f6f8; }
    .wrapper { max-width: 980px; margin: 40px auto; }
    .card-elev { border: 0; border-radius: 16px; box-shadow: 0 10px 24px rgba(20,20,20,.08); }
    .section { background:#fff; border-radius: 14px; border:1px solid #e9ecef; padding: 18px; }
    .readonly { background:#f8f9fa; }
    .gate-group .form-check { margin-right: 14px; }
    .label-muted { font-size: .85rem; color:#6c757d; }
    .header-grad { background: linear-gradient(135deg,#1e88e5 0%,#6f42c1 100%); color: #fff; border-radius: 16px; }
    .header-grad .btn { color:#fff; border-color: rgba(255,255,255,.6); }
    .mini-badge { background:#eef2ff; color:#4338ca; border-radius: 999px; padding: 4px 10px; font-size: .8rem; }
    .spinner-inline { width: 1rem; height: 1rem; vertical-align: text-bottom; margin-left: .5rem; }
    .profile-pill { background:#f1f5f9; border-radius: 999px; padding: 8px 12px; }
    .is-loading { opacity: .6; pointer-events: none; }
  </style>
</head>
<body>
  <div class="wrapper">
    <div class="card card-elev">
      <div class="card-header header-grad d-flex justify-content-between align-items-center">
        <div>
          <h3 class="m-0">Add Khokha Entry</h3>
          <div class="mini-badge mt-2">Gate Log • Secure Lookup</div>
        </div>
        <a class="btn btn-outline-light" href="<%= BASE_URL %>/new/admin">← Back</a>
      </div>

      <div class="card-body">
        <div id="alertBox" class="alert d-none" role="alert"></div>

        <!-- Roll input (auto-fetch on Enter or blur) -->
        <div class="section mb-3">
          <div class="row g-3 align-items-end">
            <div class="col-md-6">
              <label class="form-label">Roll Number</label>
              <input id="rollNumber" type="text" class="form-control" placeholder="e.g:230102013" required>
              <div class="form-text">Press <kbd>Enter</kbd> or move focus to auto-fetch and open the form.</div>
            </div>
          </div>
        </div>

        <!-- Profile preview -->
        <div class="section mb-3">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Name</label>
              <input id="name" type="text" class="form-control readonly" readonly>
            </div>
            <div class="col-md-6">
              <label class="form-label">Outlook Email</label>
              <input id="outlookEmail" type="email" class="form-control readonly" readonly>
            </div>
            <div class="col-md-6">
              <label class="form-label">Phone Number</label>
              <input id="phoneNumber" type="tel" class="form-control readonly" readonly>
            </div>
            <div class="col-md-3">
              <label class="form-label">Hostel</label>
              <input id="hostel" type="text" class="form-control readonly" readonly>
            </div>
            <div class="col-md-3">
              <label class="form-label">Room Number</label>
              <input id="roomNumber" type="text" class="form-control readonly" readonly>
            </div>
          </div>
        </div>

        <!-- Hidden submit form -->
        <form id="entryForm" method="POST" action="<%= BASE_URL %>/entries" class="d-none">
          <input type="hidden" name="name" id="f_name">
          <input type="hidden" name="rollNumber" id="f_rollNumber">
          <input type="hidden" name="outlookEmail" id="f_outlookEmail">
          <input type="hidden" name="phoneNumber" id="f_phoneNumber">
          <input type="hidden" name="hostel" id="f_hostel">
          <input type="hidden" name="roomNumber" id="f_roomNumber">
          <input type="hidden" name="destination" id="f_destination">
          <input type="hidden" name="checkOutTime" id="f_checkOutTime">
          <input type="hidden" name="checkOutGate" id="f_checkOutGate">
          <!-- REMOVED: f_checkInTime & f_checkInGate -->
        </form>

        <!-- Hint -->
        <div class="text-muted label-muted mt-2">
          <strong>Note:</strong> New entries are created as <b>Open</b>. You can close them later when the student returns.
        </div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <div>
            <h5 id="detailsModalLabel" class="modal-title">Complete Entry</h5>
            <div class="text-muted small" id="modalSummary"></div>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <div class="row g-3">
            <!-- DESTINATION: button-style radios -->
            <div class="col-12">
              <label class="form-label d-block">Destination</label>
              <div class="btn-group" role="group" aria-label="Destination">
                <input class="btn-check" type="radio" name="m_destination" id="dest_city" value="City" required>
                <label class="btn btn-outline-primary" for="dest_city">City</label>

                <input class="btn-check" type="radio" name="m_destination" id="dest_khoka" value="Khoka">
                <label class="btn btn-outline-primary" for="dest_khoka">Khoka</label>

                <input class="btn-check" type="radio" name="m_destination" id="dest_other" value="Other">
                <label class="btn btn-outline-primary" for="dest_other">Other</label>
              </div>
            </div>

            <div class="col-md-6">
              <label class="form-label">Check-Out Time</label>
              <input id="m_checkOutTime" type="datetime-local" class="form-control" required>
            </div>

            <div class="col-md-6">
              <label class="form-label d-block">Exit Gate</label>
              <div class="gate-group d-flex flex-wrap">
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="m_checkOutGate" id="m_cg_main" value="Main_Gate" required>
                  <label class="form-check-label" for="m_cg_main">Main_Gate</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="m_checkOutGate" id="m_cg_kv" value="KV_Gate">
                  <label class="form-check-label" for="m_cg_kv">KV_Gate</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="m_checkOutGate" id="m_cg_khoka" value="Khoka_Gate">
                  <label class="form-check-label" for="m_cg_khoka">Khoka_Gate</label>
                </div>
              </div>
            </div>

            <!-- REMOVED: Check-In Time + Check-In Gate -->
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal" type="button">Cancel</button>
          <button id="modalSubmitBtn" class="btn btn-success" type="button">Save Entry</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const BASE_URL = '<%= BASE_URL %>';

    // -------- helpers --------
    const alertBox = document.getElementById('alertBox');
    function showAlert(type, msg) {
      alertBox.className = 'alert alert-' + type;
      alertBox.textContent = msg;
      alertBox.classList.remove('d-none');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    function hideAlert(){ alertBox.classList.add('d-none'); }

    function setNowLocal(el) {
      const now = new Date();
      now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
      el.value = now.toISOString().slice(0,16);
    }

    // ------- Modal instance (reused) + cleanup to avoid sticky backdrops -------
    const detailsModalEl = document.getElementById('detailsModal');
    const getDetailsModal = () => bootstrap.Modal.getOrCreateInstance(detailsModalEl);

    detailsModalEl.addEventListener('hidden.bs.modal', () => {
      document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
      document.body.classList.remove('modal-open');
      document.body.style.removeProperty('padding-right');
    });

    // Prefill modal + summary
    detailsModalEl.addEventListener('show.bs.modal', () => {
      setNowLocal(document.getElementById('m_checkOutTime'));
      const n = document.getElementById('name').value || '—';
      const r = document.getElementById('rollNumber').value || '—';
      const e = document.getElementById('outlookEmail').value || '—';
      document.getElementById('modalSummary').textContent = `Submitting for ${n} (${r}) • ${e}`;
      // focus first destination button label for easy selection
      document.querySelector('label[for="dest_city"]').focus();
    });

    // Hidden form setters
    function setHiddenFromLookup({name, roll, outlookEmail, phoneNumber, hostel, roomNumber}) {
      document.getElementById('f_name').value = name || '';
      document.getElementById('f_rollNumber').value = roll || '';
      document.getElementById('f_outlookEmail').value = outlookEmail || '';
      document.getElementById('f_phoneNumber').value = phoneNumber || '';
      document.getElementById('f_hostel').value = hostel || '';
      document.getElementById('f_roomNumber').value = roomNumber || '';
    }

    // ----- AUTO-FETCH FLOW -----
    const rollInput = document.getElementById('rollNumber');
    let fetchInFlight = false;

    async function tryFetchAndOpen() {
      const roll = rollInput.value.trim();
      if (!roll || fetchInFlight) return;

      hideAlert();
      fetchInFlight = true;
      rollInput.classList.add('is-loading');

      try {
        const res = await fetch(`${BASE_URL}/entries/lookup`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ rollNumber: roll })
        });

        if (!res.ok) {
          const t = await res.text();
          throw new Error(t || 'Lookup failed');
        }

        const data = await res.json();

        // Fill readonly preview
        document.getElementById('name').value = data.name || '';
        document.getElementById('outlookEmail').value = data.outlookEmail || '';
        document.getElementById('phoneNumber').value = data.phoneNumber || '';
        document.getElementById('hostel').value = data.hostel || '';
        document.getElementById('roomNumber').value = data.roomNumber || '';

        // Hidden form
        setHiddenFromLookup({
          name: data.name,
          roll,
          outlookEmail: data.outlookEmail,
          phoneNumber: data.phoneNumber,
          hostel: data.hostel,
          roomNumber: data.roomNumber
        });

        // Open modal
        getDetailsModal().show();
      } catch (err) {
        showAlert('danger', `Failed to fetch details: ${err.message}`);
      } finally {
        fetchInFlight = false;
        rollInput.classList.remove('is-loading');
      }
    }

    // Open modal automatically after successful fetch:
    rollInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        tryFetchAndOpen();
      }
    });
    rollInput.addEventListener('blur', () => { tryFetchAndOpen(); });

    // ----- SUBMIT from modal -----
    document.getElementById('modalSubmitBtn').addEventListener('click', () => {
      const destNode = document.querySelector('input[name="m_destination"]:checked');
      const cout = document.getElementById('m_checkOutTime').value;
      const cg = document.querySelector('input[name="m_checkOutGate"]:checked');

      if (!destNode) return showAlert('warning', 'Please choose a destination.');
      if (!cout) return showAlert('warning', 'Check-Out Time is required.');
      if (!cg)   return showAlert('warning', 'Please select an Exit Gate.');

      document.getElementById('f_destination').value = destNode.value;
      document.getElementById('f_checkOutTime').value = cout;
      document.getElementById('f_checkOutGate').value = cg.value;

      // Hide modal BEFORE posting to avoid overlay during redirect
      const inst = bootstrap.Modal.getInstance(detailsModalEl);
      if (inst) inst.hide();

      // Submit the hidden form (no check-in fields anymore)
      document.getElementById('entryForm').submit();
    });

    // Autofocus roll input initially
    rollInput.focus();
  </script>
</body>
</html>
